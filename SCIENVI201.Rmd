---
title: "SCIENVI201<br>Ecology<br>Spring 2022"
date: "Last updated: `r Sys.Date()`"
output: 
  html_document:
    theme: cosmo
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: true
---

# Introduction

This page collects workshop materials, data sources and supplementary materials for the data-driven assignments in the Spring 2022 edition of Ecology at UCR.
You can also access the related files directly on [Github](https://github.com/ucrdatacenter/projects/tree/main/SCIENVI201/2022h1).

# Working with R and RStudio

## Recommended reading

It is highly recommended that you read the sections 2, 3.1-3.4 and 4-6 of [A (very) short introduction to R](https://github.com/ClaudiaBrauer/A-very-short-introduction-to-R/blob/master/documents/A\%20(very)\%20short\%20introduction\%20to\%20R.pdf) and sections 1-4 of [How to make any plot in ggplot2?](http://r-statistics.co/ggplot2-Tutorial-With-R.html#6.1\%20Make\%20a\%20time\%20series\%20plot\%20(using\%20ggfortify)) before starting working with R. 

## Installing R and RStudio

R is the programming language that you use when working with data.
RStudio is a development environment that makes working with R much more convenient.
Both are free to download and install.

To download R, go to [cloud.r-project.org](https://cloud.r-project.org/) and follow the instructions on the page.
To download RStudio, go to [rstudio.com/products/rstudio/download](https://www.rstudio.com/products/rstudio/download/), scroll down and download the file recommended for your operating system.

When installing, you can always stick to the default settings, unless you have different preferences.

In case you get stuck at any point, or would like more guidance in the installation process, feel free to check out any of the following links:

* [Tutorial: Getting Started with R and RStudio](https://www.dataquest.io/blog/tutorial-getting-started-with-r-and-rstudio/)
* [R Tutorial: How to install R and R studio (video)](https://www.youtube.com/watch?v=0Qu7Jg1Jw5A)
       
## Creating a project in RStudio

It is convenient to create an R project for an assignment that you are working on.
A project is basically a folder that stores all files related to the assignment.

You can create a project as follows:

* Open RStudio and click on "Project: (None)" in the top right corner.
* Open the dropdown window and click on "New Project...."
* In the popup window select "New Directory", then "New Project."
* Choose a sensible name for your project and enter it as the Directory Name. You can either use the default file path or change it by clicking "Browse..." next to "Create project as a subdirectory of:."
* Finally, click on "Create project."

After a project is created, there are two easy ways of accessing it. 
You can either use the same dropdown window in the top right corner of RStudio that you used to create the project, and click on the name of the project there, or you can find the project folder within your files and click on the file with the .Rproj extension.

# Assignment

These assignment instructions serve you as a guide in completing your original assignment. Here, I will walk you step by step through an example of the assignment. Once you complete this, you can start with your own variation of the assignment. Creativity is very welcome. 
In your version of the assignment you choose:
  
  - species of an interest
  - year (of Nitrogen deposition and species ocurrences)

\

<center>
<h1> **The correlation between Chaffinch, _Fringilla coelebs_, and Nitrogen deposition levels in the Netherlands** </h1>

![](https://user-images.githubusercontent.com/84587448/148916498-2fb3d7c6-5d03-4c85-9a0f-68f5efff1efe.jpg)
</center>

## LIBRARIES

Before starting with the assignment, you always need to install the libraries you have not used before with the code _install.packages(...)_. 
However, once you have installed them you do not need to do it again, but you need to load them at the beginning of every R session with the code _library(...)_.

```{r echo = TRUE, message = FALSE, eval = FALSE}

install.packages("tidyverse")
install.packages("tabularaster")
install.packages("terra")
install.packages("sf")
install.packages("readr")
install.packages("tidymodels")

```

Now, after installing all the libraries you can load them in your Rstudio, so they are ready to be used. 
This is the list of all the libraries that you need for completing the assignment. Every section has a comment which says which library you are using.

```{r echo = TRUE, message = FALSE, warning = FALSE}

library(tabularaster)
library(terra)
library(sf)
library(readr)
library(tidymodels)
library(tidyverse)

```

## DATA IMPORT

#### Nitrogen data

libraries used: _library(sf)_, _library(terra)_ and _library(tidyverse)_

Go to the website: [rivm.nl](https://www.rivm.nl/gcn-gdn-kaarten/depositiekaarten/cijfers-achter-depositiekaarten/gdn-depositiebestanden-achterliggende-jaren), and download **total Nitrogen deposition (Total stikstof (N))** from the year 2018 (ndep 2018). Once downloaded, you can see that the data is in a zipped file which cannot be worked with in R. Therefore, now you _extract all_ with the right click, and save the extracted data into a new folder called Data in your Project folder. I renamed the folder from depo_ntot_2018 to nitrogen for a simple overview, but you can order your files according to your preferences. But remember to update your code according to your files' names. Now, we can import the data on Nitrogen deposition levels to our Rstudio.

```{r echo = TRUE, message = FALSE}

Nitrogen_2018 <- rast("C:/Users/PC/Documents/GitHub/projects/SCIENVI201/2022h1/Data/nitrogen/depo_ntot_2018.asc")

```

Let's see how does the Nitrogen deposition map looks like.

```{r echo = TRUE, message = FALSE}

Nitrogen_2018 %>% 
  as.data.frame(xy=T) %>% 
  as_tibble() %>% 
  ggplot(aes(x = x, y = y, fill = depo_ntot_2018)) + 
  geom_raster()

```

#### Species data

libraries used: _library(readr)_ and _library(tidyverse)_

Go to the website: [gbif.org](gbif.org), click get data (toolbar on the top) and select occurrences. Now select, the occurrences of your species in your preferred region. Go to the toolbar on the left, under Scientific name type: **Fringilla coelebs**, in Year select: **2018**, and finally in Country or area select: **Netherlands**. Click DOWNLOAD, create an account, and select SIMPLE in download options. This step might take a little while, as the request needs to be processed. In the meantime create a chaffinch folder in your Data folder where you will store all the information on your species. Once the file is ready, click download, and save the data. It is again a zipped file which needs to be extracted. With the right click click _extract all_ and save the data into chaffinch file in the Data folder. As a last step, rename the extracted csv file to chaffinch_2018. Now, we can import the data on chaffinch, _Fringilla coelebs_, to our Rstudio.

```{r echo = TRUE, message = FALSE, warning = FALSE}

Chaffinch_2018 <- read_delim("C:/Users/PC/Documents/GitHub/projects/SCIENVI201/2022h1/Data/chaffinch/chaffinch_2018.csv", 
                             delim = "\t", escape_double = FALSE, trim_ws = TRUE)

```

Let's see where does chaffinch occur on the map.

```{r echo = TRUE, message = FALSE, warning = FALSE}

ggplot(Chaffinch_2018) +
  geom_point(aes(decimalLongitude, decimalLatitude))

```

Let's view the data set on chaffinch.

```{r echo = TRUE, message = FALSE}

Chaffinch_2018 %>% view()

```

It is a quiet big data set with 50 columns and over 60000 observations (rows). However, we do not need all the information. Therefore, in the next step we will clean our data set to our preferred size.

## DATA TIDYING

library used: _library(tidyverse)_

In this following code we select the variables with which we will be working: species names (species), longitude (decimalLongitude), and latitude (decimalLatitude)

```{r echo = TRUE, message = FALSE}

Chaffinch_2018 <- Chaffinch_2018 %>%
  dplyr::select(species, decimalLongitude, decimalLatitude) %>% # in this case you can notice that we wrote down dplyr::select instead of just typing command select(). This is because the command select() is in two of our libraries. Therefore, we wanted to specify that this select is from dplyr package which is within tidyverse.
  na.omit() %>%
  st_as_sf(coords = c("decimalLongitude","decimalLatitude")) 
  
```

libraries used: _library(sf)_ and _library(terra)_

When working with geo-spatial data, we can come across various versions of coordinate systems. Therefore, our next step is to check whether our two geo-spatial data (Nitrogen and Chaffinch) is in the same coordinate system. The code _crs(data)_ tells us in which coordinate system the geo-spatial data is. Here, the Nitrogen deposition file does not have it defined, but reading the information on the data set we know that the data set is in Amersfoort coordinate system. Therefore, we can tell the Nitrogen_2018 that it is in this format with the following code:

```{r echo = TRUE, message = FALSE}

crs(Nitrogen_2018) <- "+init=epsg:28992"

```

Next we can adjust the chaffinch coordinate system into the same coordinate system.

```{r echo = TRUE, message = FALSE, warning = FALSE}

st_crs(Chaffinch_2018) <- "+init=epsg:4326"
Chaffinch_2018 <- st_transform(Chaffinch_2018, 28992)

```

library used: _library(terra)_

Now, we do not only want to be able to see our data on a graph but also in a numeric data set. In another words, we want to see which geo-spatial point belongs to which Nitrogen level and the number of species occurring. Therefore, here we want to merge these two files and write it into a table complete_data.

```{r echo = TRUE, message = FALSE}

complete_data <- terra::extract(Nitrogen_2018, vect(Chaffinch_2018), cells = T, xy = T) %>% as_tibble() 

complete_data <- complete_data %>% 
  mutate(species = "Fringilla coelebs")

```


## PLOTTING
Once, we have our data sets available we would like to look at a graph which would show us whether there is some relationship between the level of Nitrogen and species occurrences. In the following lines of code, we have three various graphs and you need to justify yourself which one is the most informative.

```{r echo = TRUE, message = FALSE, warning = FALSE}

# BOXPLOT
boxplot(depo_ntot_2018 ~ species,
        data = complete_data,
        main = "Average Nitrogen deposition per species occurrence",
        xlab = "Chaffinch, Fringilla coelebs",
        ylab = "Nitrogen deposition (mol/(ha.year))",
        col = "orange",
        border = "brown")

# BARCHART
ggplot(complete_data) +
  geom_bar(aes(depo_ntot_2018)) +
  labs(x = "Nitrogen deposition (mol/(ha.year))",
       y = "Chaffinch, Fringilla coelebs (n)")

# FREQUENCY POLYGON
ggplot(complete_data) +
  geom_freqpoly(aes(depo_ntot_2018)) +
  labs(title = "Species occurences per Nitrogen deposition",
       x = "Nitrogen deposition (mol/(ha.year))",
       y = "Chaffinch (Fringilla coelebs) (n)")

```

## STATISTICAL ANALYSIS

library used: _library(tidyverse)_

After visually observing the relationship, now we want to see the quantitative analysis.

```{r echo = TRUE, message = FALSE, warning = FALSE}

# calling our frequency polygon f
f <- ggplot(complete_data) +
  geom_freqpoly(aes(depo_ntot_2018)) +
  labs(title = "Species occurences per Nitrogen deposition",
       x = "Nitrogen deposition (mol/(ha.year))",
       y = "Chaffinch (Fringilla coelebs) (n)")

# writing a function which extracts values from frequency polygon
get_fpoly <- function(p) {
  d <- ggplot_build(p)$data[[1]]
  data.frame(x = d$x, xmin = d$xmin, xmax = d$xmax, y = d$y)
}

# extracting x and y variables with the extracting function (get_fpoly) from frequency polygen (f).
x <- get_fpoly(f)$x
y <- get_fpoly(f)$y

# writing a table with x and y variables and calling it t
t <- tibble(x, y)

# visualizing the relationship
ggplot(t, aes(x, y)) +
  geom_point() +
  geom_smooth(method = lm, formula = y ~ poly(x, 2), se = FALSE)

## library needed: library(tidymodels)
## statistical resutls
lm(y~poly(x, 2),t) %>%
  tidy()

```

# Supporting materials

## The basics of R

* [Cheat sheet for importing data](https://github.com/rstudio/cheatsheets/blob/main/data-import.pdf)
* [Cheat sheet for data manipulation](https://github.com/rstudio/cheatsheets/blob/main/data-transformation.pdf) (including `filter()`, `select()` and the pipe operator(`%>%`))
* [Cheat sheet for data tidying](https://github.com/rstudio/cheatsheets/blob/main/tidyr.pdf) (including reshaping and pivoting)
* [Getting started with Data in R](https://moderndive.netlify.app/1-getting-started.html#getting-started) (covers: using R and RStudio, basic terminology, introduction to packages)
* [R objects](https://rstudio-education.github.io/hopr/r-objects.html)
* [More explanation on the pipe operator](https://r4ds.had.co.nz/pipes.html)
* [Advice on using projects](https://r4ds.had.co.nz/workflow-projects.html)
* [Selecting and filtering data](https://mdsr-book.github.io/mdsr2e/ch-dataI.html#sec:pipe)
* [Conversions between long and wide format](https://mdsr-book.github.io/mdsr2e/ch-dataII.html#data-verbs-for-converting-wide-to-narrow-and-vice-versa)
* [Creating a project in RStudio (video)](https://www.youtube.com/watch?v=WyrJmJWgPiU)
* [Packages in R (video)](https://www.youtube.com/watch?v=v6VygIgvoZU&t=1s)
* [Loading a data file (video)](https://www.youtube.com/watch?v=2MVolYETR5Q)
* [Data manipulation (video)](https://www.youtube.com/watch?v=Zc_ufg4uW4U)

## Help with `ggplot`

* [Cheat sheet for `ggplot`](https://github.com/rstudio/cheatsheets/blob/main/data-visualization-2.1.pdf)
* [The R Graph Gallery (example plots, including full R scripts)](https://www.r-graph-gallery.com/)
* [More details on data visualization](https://mdsr-book.github.io/mdsr2e/ch-vizII.html#a-grammar-for-data-graphics)
* [Saving plots with `ggsave()`](https://www.tutorialgateway.org/save-r-ggplot-using-ggsave/)
* [Basic `ggplot` tutorial (video)](https://www.youtube.com/watch?v=hr2X7rmkprM)
* [Customizing plots (video)](https://www.youtube.com/watch?v=1GmQ5BdAhG4)
